from robot_hat import Pin, Ultrasonic, Grayscale_Module, ADC
from picarx import Picarx
import time
import keyboard

px = Picarx()
grayscale = Grayscale_Module(ADC(0), ADC(1), ADC(2), reference=2000)

# âš™ï¸ GÃœNCELLENMÄ°Å AYARLAR
STEERING_OFFSET = -9              # Direksiyon sola kayÄ±k â†’ saÄŸa Ã§ekiyoruz
GRAYSCALE_THRESHOLD = 100         # BoÅŸluk algÄ±lamak iÃ§in hassas eÅŸik
ULTRASONIC_THRESHOLD = 20         # 10 cm'den yakÄ±nsa engel kabul edilir

# ğŸ”§ Direksiyon fonksiyonu
def steer(angle):
    px.set_dir_servo_angle(angle + STEERING_OFFSET)

# ğŸ” Engel kontrolÃ¼ + log
def engel_var_mi():
    distance = px.ultrasonic.read()

    if distance is None:
        print("âš ï¸ Ultrasonik Ã¶lÃ§Ã¼m hatasÄ± (None)")
        return False
    elif distance < 0:
        print(f"âš ï¸ Ultrasonik geÃ§ersiz Ã¶lÃ§Ã¼m: {distance}")
        return False
    elif distance < ULTRASONIC_THRESHOLD:
        print(f"ğŸš§ GerÃ§ek engel algÄ±landÄ±: {distance:.2f} cm")
        return True
    return False

# ğŸ” BoÅŸluk (uÃ§urum) kontrolÃ¼ + log
def bosluk_var_mi():
    left = grayscale.read(grayscale.LEFT)
    middle = grayscale.read(grayscale.MIDDLE)
    right = grayscale.read(grayscale.RIGHT)
    print(f"ğŸ›ï¸ Grayscale L:{left:.0f} M:{middle:.0f} R:{right:.0f}")

    if left < GRAYSCALE_THRESHOLD or middle < GRAYSCALE_THRESHOLD or right < GRAYSCALE_THRESHOLD:
        print("ğŸ•³ï¸ BoÅŸluk (beyaz yÃ¼zey) algÄ±landÄ±!")
        return True
    return False

# ğŸ§  BaÅŸlangÄ±Ã§
print("ğŸ§  Sistem Ã§alÄ±ÅŸÄ±yor. 'w' ile ileri, 's' ile geri. Tehlikede ileri engellenir.")

try:
    while True:
        tehlike_ultrasonik = engel_var_mi()
        tehlike_grayscale = bosluk_var_mi()
        tehlike = tehlike_ultrasonik or tehlike_grayscale

        # Direksiyon
        if keyboard.is_pressed('a'):
            steer(-30)
        elif keyboard.is_pressed('d'):
            steer(30)
        else:
            steer(0)

        # Hareket
        if keyboard.is_pressed('w') and not tehlike:
            px.forward(30)
        elif keyboard.is_pressed('s'):
            px.backward(30)
        else:
            px.stop()

        # Ã‡Ä±kÄ±ÅŸ
        if keyboard.is_pressed('q'):
            px.stop()
            print("ğŸ›‘ Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.")
            break

        time.sleep(0.05)

except KeyboardInterrupt:
    px.stop()
    print("\nğŸ›‘ Manuel durduruldu.")
